<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Juego TranvÃ­a</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100vh; width: 100vw;
      background: url('fondo_vias.png') no-repeat center/contain;
      background-color: #eaeaea;
      font-family: sans-serif;
      overflow: hidden;
    }

    #marco {
      position: relative;
      max-width: 480px;
      height: 100vh;
      margin: 0 auto;
      width: 100vw;
    }

    #barra-superior {
      position: absolute;
      top: 20px;
      left: 14px;
      right: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 20;
    }

    #temporizador {
      padding: 6px 14px;
      font-weight: bold;
      font-size: 22px;
      background: rgba(0,0,0,0.65);
      color: white;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(255,0,0,0.6);
      user-select: none;
      min-width: 60px;
      text-align: center;
      display: none;
    }

    #altavoz {
      width: 40px;
      height: 40px;
      cursor: pointer;
      user-select: none;
    }

    #altavoz svg {
      width: 100%;
      height: 100%;
      fill: white;
    }

    #palanca {
      position: absolute;
      bottom: 18%;
      left: 50%;
      transform: translateX(-50%) rotate(0deg);
      transform-origin: bottom center;
      width: 50px;
      height: 140px;
      cursor: pointer;
      user-select: none;
      z-index: 15;
      transition: transform 0.3s ease;
    }

    #palanca .mango {
      width: 12px;
      height: 90px;
      background: #4d2c19;
      margin: 0 auto;
      border-radius: 6px;
      position: relative;
      border: 2px solid #2e1a0f;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.4);
    }

    #palanca .mango::before {
      content: "";
      position: absolute;
      top: -28px;
      left: 50%;
      transform: translateX(-50%);
      width: 34px;
      height: 34px;
      background: #5a1e1e;
      border: 3px solid #3b0d0d;
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.4);
    }

    #palanca .base {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 24px;
      background: #444;
      border-radius: 6px;
      border: 2px solid #222;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.3);
    }

    #confirmar {
      position: absolute;
      bottom: 10%;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      z-index: 25;
      background-color: #8b1a1a;
      color: white;
      font-size: 18px;
      font-weight: bold;
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }

  /* ðŸ”´ PARPADEO ROJO AL FINAL */
  #parpadeo {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(255, 0, 0, 0.3);
    display: none;
    pointer-events: none;
    z-index: 1;
    animation: parpadeoRojo 1s infinite;
  }

  @keyframes parpadeoRojo {
    0%   { opacity: 1; }
    50%  { opacity: 0; }
    100% { opacity: 1; }
  }

    #mensaje-perder,
    #popup-final {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 28px;
      font-weight: bold;
      color: white;
      display: none;
      z-index: 50;
      text-align: center;
      background-color: rgba(0, 0, 0, 0.8);
      padding: 28px 36px;
      border-radius: 14px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
    }

    #mensaje-perder button,
    #popup-final button {
      margin-top: 18px;
      padding: 14px 32px;
      font-size: 18px;
      border-radius: 10px;
      background-color: #8b1a1a;
      border: none;
      color: white;
      cursor: pointer;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .via {
      position: absolute;
      width: 40%;
      height: 180px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      top: 53%;
      z-index: 1;
    }

    .via.via1 { left: 5%; }
    .via.via2 { right: 5%; }

    .carta {
      width: 120px;
      height: 160px;
      border: 2px solid #333;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      margin-top: -140px;
      position: absolute;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      overflow: hidden;
      transition: transform 0.8s ease, left 0.8s ease, top 0.8s ease;
      background-color: white;
    }

    .carta img {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      object-fit: cover;
    }
    #parpadeo {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: rgba(255, 0, 0, 0.4);
  z-index: 9999;
  animation: parpadeoRojo 1s infinite;
  pointer-events: none;
}

@keyframes parpadeoRojo {
  0%, 100% {
    opacity: 0;
  }
  50% {
    opacity: 1;
  }
}
  </style>
  
</head>
<script>
  const nombresCartas = [
    'buena', 'mala', 'neutra', 'absurda', 'adulta'
  ];
  const imagenes = [];

  for (let tipo of nombresCartas) {
    for (let i = 1; i <= 6; i++) {
      const img = new Image();
      img.src = `cartas/${tipo}_${i}.png`;
      imagenes.push(img);
    }
  }
</script>

<body>
  <div id="parpadeo"></div>
    <audio id="tren-sound" src="tren_sonido.mp3" preload="auto"></audio>
<audio id="horn-sound" src="bocina.mp3" preload="auto"></audio>
<script>
  const tren = document.getElementById('tren-sound');
  const horn = document.getElementById('horn-sound');

  const desbloquearSonidos = () => {
    tren.play().then(() => tren.pause()).catch(() => {});
    horn.play().then(() => horn.pause()).catch(() => {});
    document.removeEventListener('click', desbloquearSonidos);
  };
  document.addEventListener('click', desbloquearSonidos);
</script>

    <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('Service Worker registrado', reg))
        .catch(err => console.log('Error al registrar SW', err));
    });
  }
</script>
  <div id="marco">
    <div id="barra-superior">
      <div id="temporizador">55</div>
      <div id="altavoz">
        <svg viewBox="0 0 24 24">
          <path d="M3 10v4h4l5 5V5l-5 5H3zm13.5 2a4.5 4.5 0 01-3 4.24v-8.48A4.5 4.5 0 0116.5 12z"/>
        </svg>
      </div>
    </div>

    <div class="parpadeo" id="parpadeo"></div>

    <div id="palanca">
      <div class="mango"></div>
      <div class="base"></div>
    </div>

    <button id="confirmar">Confirmar</button>

    <div id="mensaje-perder">
      <p>Has perdido...</p>
      <button id="boton-reintentar">Reintentar</button>
    </div>

    <div id="popup-final">
      <p id="frase-final"></p>
      <button onclick="location.reload()">Nueva partida</button>
      <button onclick="location.href='configuracion.html'">Salir</button>
    </div>

    <div class="via via1" id="via1"></div>
    <div class="via via2" id="via2"></div>
  </div>

  <script>
    const frasesFinales = ["Â¿En serio? No te juzgo, pero...",
      "Escuchamos Y Juzgamos",
      "Karma",
      "A tu madre no le gustarÃ­a",
      "Demasiado tarde para arrepentirse",
      "Solo Dios puede juzgarte... pero nosotros tambiÃ©n lo haremos.",
      "El botÃ³n decÃ­a â€œConfirmarâ€, no â€œCondenarâ€.",
      "Alguien tenÃ­a que hacerlo... supongo.",
      "Â¡Plot twist innecesario!",
      "Esto irÃ¡ directamente a tu expediente.",
      "No lo negarÃ¡s cuando te interroguen, Â¿verdad?",
      "Ni los filÃ³sofos antiguos justificarÃ­an esto.",
      "Bien jugado. Mal, pero jugado.",
      "Â¿Y si simplemente no hacÃ­as nada?",
      "Â¡Tus terapeutas futuros te agradecerÃ¡n esto!",
      "Lo tuyo no es la moral, Â¿eh?",
      "No somos quiÃ©n para decir nada... pero wow.",
      "Otra alma al infierno. Siguiente.",
      "Â¿Esto cuenta como libre albedrÃ­o?",
      "Tu lado oscuro estÃ¡ tomando decisiones ahora.",
      "Notamos cierta falta de remordimiento.",
      "EsperÃ¡bamos mÃ¡s de ti. Bueno, no realmente.",
      "Alguien estÃ¡ disfrutando esto demasiado.",
      "Tus padres estarÃ­an orgullosos. O no.",
      "Casi eliges bien. Casi.",
      "El tranvÃ­a aprueba tu sacrificio.",
      "Â¿Te sientes poderoso? Porque deberÃ­as sentirte mal.",
      "Esto fue personal, Â¿verdad?",
      "Lo que acaba de pasar... no se olvida.",
      "Punto extra por originalidad moral cuestionable.",
      "Al menos no fue al azar. Â¿O sÃ­?",
      "Todos tenemos dÃ­as malos... tÃº tienes rachas.",
      "El universo toma nota.",
      "En otra vida seguro eras villano.",
      "Tu conciencia pidiÃ³ vacaciones.",
      "Modo Dios: Activado.",
      "Â¿Y si el tranvÃ­a eras tÃº todo este tiempo?",
      "Esa no era la respuesta correcta (spoiler: no habÃ­a ninguna).",
      "Un giro inesperado... al lado oscuro.",
      "Jugaste con fuego y quemaste inocentes.",
      "Â¿Este era tu plan desde el principio?",
      "SiÃ©ntete libre de racionalizarlo.",
      "Las cartas no lo merecÃ­an.",
      "Ese camino no vuelve atrÃ¡s.",
      "La vÃ­a ha hablado. Y estÃ¡ decepcionada.",
      "Bueno... al menos no fue aburrido.",
      "Tranquilo, solo era una simulaciÃ³n. Â¿O no?",
      "Esto va a requerir una sesiÃ³n de meditaciÃ³n.",
      "Nadie saliÃ³ ileso. Empezando por tu conciencia.",
      "Elige sabiamente, decÃ­an. Ya es tarde.",
      "Te vas directo al infierno del tranvÃ­a",
      "Interesante elecciÃ³n... para un sociÃ³pata",
      "Tu terapeuta oirÃ¡ de esto",
      "Ni Freud lo entenderÃ­a",
      "El tranvÃ­a tambiÃ©n llora",
      "Genial, acabas de romper la Ã©tica",
      "Plot twist: tÃº eras el villano",
      "Â¿Y si el tranvÃ­a te atropella a ti?",
      "Moralidad: Inexistente",
      "Oye, nadie dijo que eras buena persona",
      "Felicidades, ya no eres el protagonista",
      "Al menos lo hiciste con convicciÃ³n",
      "Ese fue un giro oscuro",
      "Esperaba algo mejor de ti... aunque no mucho",
      "Las cartas te juzgan en silencio",
      "Nadie estÃ¡ a salvo de tus decisiones",
      "Tu Ã¡ngel de la guarda se fue",
      "Esa decisiÃ³n fue tan mala que duele",
      "Juez, jurado y ejecutor moral",
      "No sabÃ­amos que eras asÃ­...",
      "Lo veremos en tu biopic criminal",
      "Â¿Era esto parte de tu plan maestro?",
      "100% cuestionable, 0% remordimiento",
      "Ups... era tu tÃ­a abuela en la vÃ­a",
      "Claramente necesitas dormir mÃ¡s",
      "A este ritmo te contrata el villano",
      "Wow. Simplemente... wow",
      "No lo vimos venir. Ni querÃ­amos",
      "Un aplauso por la peor decisiÃ³n del dÃ­a",
      "Google te busca por crÃ­menes Ã©ticos",
      "Tus cartas estÃ¡n decepcionadas",
      "Eso fue legal, pero no moral",
      "Una elecciÃ³n digna del Joker",
      "Tienes el alma de un cactus seco",
      "MamÃ¡ estarÃ­a orgullosa... quizÃ¡s no",
      "Â¿EstÃ¡s bien? Â¿Seguro?",
      "El karma te alcanzarÃ¡ en 3... 2...",
      "Elegiste la oscuridad. Con estilo",
      "Eso... eso fue frÃ­o",
      "El tren te lleva directo al juicio final",
      "Tus nietos lo leerÃ¡n en tus memorias",
      "En otro universo, hiciste lo correcto",
      "Si fueras polÃ­tico, tendrÃ­as futuro",
      "Lo sentimos, se acabÃ³ tu prueba moral",
      "No hay vuelta atrÃ¡s, conductor oscuro"
    ];
    const config = JSON.parse(localStorage.getItem("configJuego") || "{}");
    const usarCronometro = config.cronometro === true;
    let tiempo = 55;
    let intervalo = null;
    let sonidoActivo = true;
    let palancaEstado = 0;

    const temporizador = document.getElementById("temporizador");
    const parpadeo = document.getElementById("parpadeo");
    const mensajePerder = document.getElementById("mensaje-perder");
    const botonReintentar = document.getElementById("boton-reintentar");
    const palanca = document.getElementById("palanca");
    const confirmar = document.getElementById("confirmar");
    const altavoz = document.getElementById("altavoz");

    const tren_sonido = new Audio("tren_sonido.mp3");
tren_sonido.loop = !usarCronometro;

document.body.addEventListener('click', () => {
  tren_sonido.play().catch(() => {});
}, { once: true });

    tren_sonido.loop = !usarCronometro;
    const bocina = new Audio("bocina.mp3");

    function iniciarCronometro() {
  if (!usarCronometro) return;
  temporizador.textContent = tiempo;
  intervalo = setInterval(() => {
    tiempo--;
    temporizador.textContent = tiempo;

    // Activar parpadeo rojo desde 10 segundos hasta 0
    if (tiempo <= 10 && tiempo > 0) {
      parpadeo.style.display = "block";
      if (tiempo === 10 && sonidoActivo) {
        bocina.play().catch(() => {});
      }
    }

    // Tiempo agotado
    if (tiempo <= 0) {
      clearInterval(intervalo);
      parpadeo.style.display = "none"; // Oculta parpadeo al terminar
      mostrarPerdida();
    }
  }, 1000);
}

    function mostrarPerdida() {
      parpadeo.style.display = "none";
      mensajePerder.style.display = "block";
      tren_sonido.pause();
    }

    botonReintentar.onclick = () => location.reload();

    altavoz.onclick = () => {
      sonidoActivo = !sonidoActivo;
      altavoz.querySelector("svg").style.fill = sonidoActivo ? "white" : "gray";
      if (sonidoActivo) tren_sonido.play().catch(() => {});
      else {
        tren_sonido.pause();
        bocina.pause();
        bocina.currentTime = 0;
      }
    };

    palanca.onclick = () => {
      palancaEstado = palancaEstado <= 0 ? 1 : -1;
      palanca.style.transform = `translateX(-50%) rotate(${palancaEstado * 20}deg)`;
      confirmar.style.display = "block";
    };

    confirmar.onclick = () => {
      confirmar.style.display = "none";
      tren_sonido.pause();
      clearInterval(intervalo);
      parpadeo.style.display = "none";

      const viaSeleccionada = palancaEstado > 0 ? "via2" : "via1";
      const cartas = document.querySelectorAll(`#${viaSeleccionada} .carta`);
      cartas.forEach((carta, i) => {
        const angulo = Math.random() * 360;
        const distancia = 300 + Math.random() * 300;
        const x = Math.cos(angulo) * distancia;
        const y = Math.sin(angulo) * distancia;
        carta.style.transition = "transform 1s ease, left 1s ease, top 1s ease";
        carta.style.left = `50%`;
        carta.style.top = `50%`;
        carta.style.transform = `translate(${x}px, ${y}px) rotate(${angulo}deg)`;
        carta.style.zIndex = 40 + i;
      });

      setTimeout(() => {
        const frase = frasesFinales[Math.floor(Math.random() * frasesFinales.length)];
        document.getElementById("frase-final").textContent = frase;
        document.getElementById("popup-final").style.display = "block";
      }, 1000);
    };

    const cartasDisponibles = Array.from({ length: 6 }, (_, i) => i + 1).flatMap(num => [
      `buena_${num}`,
      `mala_${num}`,
      `neutra_${num}`,
      `absurda_${num}`,
      `adulta_${num}`
    ]);

    const cartas = {
      buenas: cartasDisponibles.filter(c => c.startsWith("buena")),
      malas: cartasDisponibles.filter(c => c.startsWith("mala")),
      otras: cartasDisponibles.filter(c => c.startsWith("neutra") || c.startsWith("absurda")),
      adultas: cartasDisponibles.filter(c => c.startsWith("adulta"))
    };

    function obtenerCartasAleatorias(lista, cantidad, usadas) {
      const disponibles = lista.filter(c => !usadas.has(c));
      const seleccionadas = [];
      while (disponibles.length && seleccionadas.length < cantidad) {
        const index = Math.floor(Math.random() * disponibles.length);
        const carta = disponibles.splice(index, 1)[0];
        seleccionadas.push(carta);
        usadas.add(carta);
      }
      return seleccionadas;
    }

    function generarCartasParaAmbasVias() {
      const usadas = new Set();
      const cantidad = (lista) => Math.min(lista.length, Math.floor(Math.random() * 3) + 1);
      const generar = () => {
        const b = config.buenas ?? cantidad(cartas.buenas);
        const m = config.malas ?? cantidad(cartas.malas);
        const o = config.otras ?? Math.floor(Math.random() * 3);
        let baraja = [
          ...obtenerCartasAleatorias(cartas.buenas, b, usadas),
          ...obtenerCartasAleatorias(cartas.malas, m, usadas),
          ...obtenerCartasAleatorias(cartas.otras, o, usadas)
        ];
        if (config.modo18) {
          baraja.push(...obtenerCartasAleatorias(cartas.adultas, 1, usadas));
        }
        return baraja.sort(() => Math.random() - 0.5);
      };
      return [generar(), generar()];
    }

    function montarPila(viaId, cartasVia) {
      const via = document.getElementById(viaId);
      via.innerHTML = "";
      cartasVia.forEach((nombre, i) => {
        const div = document.createElement("div");
        div.className = "carta";
        div.style.top = `${i * 5}px`;
        div.style.zIndex = i;
        const img = document.createElement("img");
        img.src = `cartas/${nombre}.png`;
        img.alt = nombre;
        div.appendChild(img);
        via.appendChild(div);
      });
      via.onclick = () => {
        const pila = Array.from(via.children);
        if (pila.length > 1) {
          const top = pila.pop();
          via.insertBefore(top, via.firstChild);
          Array.from(via.children).forEach((carta, j) => {
            carta.style.top = `${j * 5}px`;
            carta.style.zIndex = j;
          });
        }
      };
    }

    window.onload = () => {
      if (sonidoActivo) tren_sonido.play().catch(() => {});
      if (usarCronometro) {
        temporizador.style.display = "block";
        iniciarCronometro();
      } else {
        temporizador.style.display = "none";
      }

      const [via1Cartas, via2Cartas] = generarCartasParaAmbasVias();
      montarPila("via1", via1Cartas);
      montarPila("via2", via2Cartas);
    };
  </script>
</body>
</html>
